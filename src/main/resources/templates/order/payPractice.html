<!DOCTYPE html>
<html lang="en">
<head>
    <!-- jQuery -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
    <!-- iamport.payment.js -->
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script>

        /*<![CDATA[*/
        let merchant_uid = [[${list.rno}]];
        let amount = [[${list.arp_count}]]*[[${list.arp_price}]];
        let pay_method;
        /*]]>*/

        const getselect = (target) => {

            pay_method = target.value;
        }

        IMP.init("imp11477517");

        function requestPay() {
            console.log(pay_method);
            IMP.request_pay({
                //pg : 'kcp',
                pg : pay_method,
                pay_method : 'card',
                merchant_uid: merchant_uid, //주문번호
                name : '주문명:결제테스트',
                amount : amount, //숫자타입 (금액)
            }, function (rsp) { // callback
                if (rsp.success) {
                    //결제 성공시: 결제 승인 또는 가상계좌 발급에 성공한 경우
                    //제이쿼리로 HTTP 요청
                    $.ajax({
                        url: "/order/payment/complete",
                        method: "POST",
                        data: {
                            imp_uid: rsp.imp_uid,            // 결제 고유번호 (알아서 생성된다.)
                            merchant_uid: rsp.merchant_uid,  // 주문번호
                            pay_method : pay_method
                        }
                    }).done(function (data) {
                        // 가맹점 서버 결제 API 성공시 로직
                        swal({
                            text: data,
                            closeOnClickOutside: false
                        })
                            .then(function () {
                                location.replace("/");
                            })
                    })//done
                        .fail(function (data){
                            alert("결제가 실패하였습니다.");
                        })
                } else {
                    //실패 로직
                    console.log(rsp);
                }
            });
        }
        /*]]>*/
    </script>
    <meta charset="UTF-8">
    <title>Sample Payment</title>
</head>
<body>
<div class="admin-content">
    <table>
        <thead>
        <tr>
            <th>예약번호</th>
            <th>항공번호</th>
            <th>회원번호</th>
            <th>수량</th>
            <th>금액</th>
            <th>예약날짜</th>
            <th>총금액</th>
        </tr>
        </thead>
        <tr>
            <td th:value="${list.rno}" th:text="${list.rno}"></td>
            <td th:value="${list.ano}" th:text="${list.ano}"></td>
            <td th:value="${list.mno}" th:text="${list.mno}"></td>
            <td th:value="${list.arp_count}" th:text="${list.arp_count}"></td>
            <td th:value="${list.arp_price}" th:text="${list.arp_price}"></td>
            <td th:value="${list.arp_date}" th:text="${list.arp_date}"></td>
            <td th:value="${list.arp_count}*${list.arp_price}" th:text="${list.arp_count}*${list.arp_price}"></td>
        </tr>
    </table>
    <br>
    <div> 결제수단
        <label><input type="radio" name="method" value="kcp" onchange="getselect(this)"/>신용카드</label>
        <label><input type="radio" name="method" value="kakaopay" onchange="getselect(this)"/>카카오페이</label>
    </div><br>
    <td>
        <button onclick="requestPay()">결제하기</button>
    </td>
</div>
</body>
</html>